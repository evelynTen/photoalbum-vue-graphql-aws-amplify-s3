{"ast":null,"code":"import isEmpty from 'lodash/isEmpty';\nimport isEqual from 'lodash/isEqual';\nimport { v1 as uuid } from 'uuid';\nimport { ConsoleLogger as Logger, browserOrNode } from '@aws-amplify/core';\nimport { Cache } from '@aws-amplify/cache';\nvar PERSONALIZE_CACHE = '_awsct';\nvar PERSONALIZE_CACHE_USERID = '_awsct_uid';\nvar PERSONALIZE_CACHE_SESSIONID = '_awsct_sid';\nvar DEFAULT_CACHE_PREFIX = 'peronslize';\nvar TIMER_INTERVAL = 30 * 1000;\nvar DELIMITER = '.';\nvar CACHE_EXPIRY_IN_DAYS = 7;\nvar logger = new Logger('AmazonPersonalizeProvider');\nvar SessionInfoManager = /** @class */function () {\n  function SessionInfoManager(prefixKey) {\n    if (prefixKey === void 0) {\n      prefixKey = '';\n    }\n    this._isBrowser = browserOrNode().isBrowser;\n    this._timerKey = uuid().substr(0, 15);\n    this._refreshTimer();\n  }\n  SessionInfoManager.prototype._refreshTimer = function () {\n    if (this._timer) {\n      clearInterval(this._timer);\n    }\n    var that = this;\n    this._timer = setInterval(function () {\n      that._timerKey = uuid().substr(0, 15);\n    }, TIMER_INTERVAL);\n  };\n  SessionInfoManager.prototype.storeValue = function (key, value) {\n    var today = new Date();\n    var expire = new Date();\n    expire.setTime(today.getTime() + 3600000 * 24 * CACHE_EXPIRY_IN_DAYS);\n    Cache.setItem(this._getCachePrefix(key), value, {\n      expires: expire.getTime()\n    });\n  };\n  SessionInfoManager.prototype.retrieveValue = function (key) {\n    return Cache.getItem(this._getCachePrefix(key));\n  };\n  SessionInfoManager.prototype._getCachePrefix = function (key) {\n    if (this._isBrowser) {\n      return key + DELIMITER + window.location.host;\n    }\n    return DEFAULT_CACHE_PREFIX;\n  };\n  SessionInfoManager.prototype.getTimerKey = function () {\n    return this._timerKey;\n  };\n  SessionInfoManager.prototype.updateSessionInfo = function (userId, sessionInfo) {\n    var existUserId = sessionInfo.userId;\n    var existSessionId = sessionInfo.sessionId;\n    if (this._isRequireNewSession(userId, existUserId, existSessionId)) {\n      var newSessionId = uuid();\n      this.storeValue(PERSONALIZE_CACHE_USERID, userId);\n      this.storeValue(PERSONALIZE_CACHE_SESSIONID, newSessionId);\n      sessionInfo.sessionId = newSessionId;\n    } else if (this._isRequireUpdateSessionInfo(userId, existUserId, existSessionId)) {\n      this.storeValue(PERSONALIZE_CACHE_USERID, userId);\n    }\n    sessionInfo.userId = userId;\n  };\n  SessionInfoManager.prototype._isRequireUpdateSessionInfo = function (userId, cachedSessionUserId, cachedSessionSessionId) {\n    // anonymouse => sign in : hasSession && s_userId == null && curr_userId !=null\n    var isNoCachedSession = isEmpty(cachedSessionSessionId);\n    return !isNoCachedSession && isEmpty(cachedSessionUserId) && !isEmpty(userId);\n  };\n  SessionInfoManager.prototype.retrieveSessionInfo = function (trackingId) {\n    var sessionInfo = {};\n    sessionInfo.trackingId = trackingId;\n    sessionInfo.sessionId = this.retrieveValue(PERSONALIZE_CACHE_SESSIONID);\n    sessionInfo.userId = this.retrieveValue(PERSONALIZE_CACHE_USERID);\n    if (isEmpty(sessionInfo.sessionId)) {\n      sessionInfo.sessionId = uuid();\n      this.storeValue(PERSONALIZE_CACHE_SESSIONID, sessionInfo.sessionId);\n    }\n    this.storeValue(PERSONALIZE_CACHE, trackingId);\n    return sessionInfo;\n  };\n  SessionInfoManager.prototype._isRequireNewSession = function (userId, cachedSessionUserId, cachedSessionSessionId) {\n    // new session => 1. no cached session info 2. signOut: s_userId !=null && curr_userId ==null\n    // 3. switch account: s_userId !=null && curr_userId !=null && s_userId != curr_userId\n    var isNoCachedSession = isEmpty(cachedSessionSessionId);\n    var isSignoutCase = isEmpty(userId) && !isEmpty(cachedSessionUserId);\n    var isSwitchUserCase = !isEmpty(userId) && !isEmpty(cachedSessionUserId) && !isEqual(userId, cachedSessionUserId);\n    return isNoCachedSession || isSignoutCase || isSwitchUserCase;\n  };\n  return SessionInfoManager;\n}();\nexport { SessionInfoManager };","map":{"version":3,"mappings":"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","names":["isEmpty","isEqual","v1","uuid","ConsoleLogger","Logger","browserOrNode","Cache","PERSONALIZE_CACHE","PERSONALIZE_CACHE_USERID","PERSONALIZE_CACHE_SESSIONID","DEFAULT_CACHE_PREFIX","TIMER_INTERVAL","DELIMITER","CACHE_EXPIRY_IN_DAYS","logger","prefixKey","_isBrowser","isBrowser","_timerKey","substr","_refreshTimer","SessionInfoManager","_timer","clearInterval","that","setInterval","key","value","today","Date","expire","setTime","getTime","setItem","_getCachePrefix","expires","getItem","window","location","host","userId","sessionInfo","existUserId","existSessionId","sessionId","_isRequireNewSession","newSessionId","storeValue","_isRequireUpdateSessionInfo","cachedSessionUserId","cachedSessionSessionId","isNoCachedSession","trackingId","retrieveValue","isSignoutCase","isSwitchUserCase"],"sourceRoot":"","sources":["../../../src/Providers/AmazonPersonalizeHelper/SessionInfoManager.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"module","externalDependencies":[]}